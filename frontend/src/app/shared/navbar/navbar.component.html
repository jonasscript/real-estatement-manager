<!-- ============================================ -->
<!-- LEFT SIDEBAR - Menu Principal -->
<!-- ============================================ -->
<aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
  <!-- Sidebar Header - Brand -->
  <div class="sidebar-header">
    <a class="sidebar-brand" routerLink="/dashboard">
      <div class="brand-icon">
        <i class="fas fa-building"></i>
      </div>
      <span class="brand-text" *ngIf="!isSidebarCollapsed">Real Estate SAS</span>
    </a>
    
    <!-- Toggle Button -->
    <button class="sidebar-toggle" (click)="toggleSidebar()" *ngIf="!isSidebarCollapsed">
      <i class="fas fa-chevron-left"></i>
    </button>
  </div>

  <!-- Sidebar Menu -->
  <nav class="sidebar-nav" aria-label="Menú principal de navegación">
    <!-- Loading State -->
    <div class="sidebar-loading" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <span *ngIf="!isSidebarCollapsed">Cargando menú...</span>
    </div>

    <!-- Menu Items -->
    <ul class="sidebar-menu" *ngIf="!loading">
      <ng-container *ngFor="let menu of menuOptions; trackBy: trackByMenuId">
        <!-- Menu without children -->
        <li class="sidebar-menu-item" *ngIf="!menu.children || menu.children.length === 0">
          <a class="sidebar-menu-link"
             [routerLink]="menu.path"
             routerLinkActive="active"
             [routerLinkActiveOptions]="{exact: false}"
             [title]="menu.label">
            <i [class]="getIconClass(menu.icon)"></i>
            <span class="menu-label" *ngIf="!isSidebarCollapsed">{{ menu.label }}</span>
          </a>
        </li>

        <!-- Menu with children -->
        <li class="sidebar-menu-item has-submenu" *ngIf="menu.children && menu.children.length > 0">
          <a class="sidebar-menu-link"
             (click)="toggleSubmenu(menu.id)"
             [class.active]="isSubmenuOpen(menu.id)"
             [title]="menu.label">
            <i [class]="getIconClass(menu.icon)"></i>
            <span class="menu-label" *ngIf="!isSidebarCollapsed">{{ menu.label }}</span>
            <i class="fas fa-chevron-down submenu-icon" *ngIf="!isSidebarCollapsed"></i>
          </a>
          
          <!-- Submenu -->
          <ul class="sidebar-submenu" *ngIf="isSubmenuOpen(menu.id) && !isSidebarCollapsed">
            <li *ngFor="let child of menu.children; trackBy: trackByMenuId">
              <a class="sidebar-submenu-link"
                 [routerLink]="child.path"
                 routerLinkActive="active"
                 [title]="child.label">
                <i [class]="getIconClass(child.icon)"></i>
                <span>{{ child.label }}</span>
              </a>
            </li>
          </ul>
        </li>
      </ng-container>

      <!-- Empty State -->
      <li class="sidebar-empty" *ngIf="menuOptions.length === 0 && currentUser">
        <i class="fas fa-exclamation-circle"></i>
        <span *ngIf="!isSidebarCollapsed">Sin opciones de menú</span>
      </li>
    </ul>
  </nav>

  <!-- Sidebar Footer - Collapse Button -->
  <div class="sidebar-footer" *ngIf="isSidebarCollapsed">
    <button class="sidebar-expand-btn" (click)="toggleSidebar()" title="Expandir menú">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</aside>

<!-- ============================================ -->
<!-- TOP NAVBAR - Search, Actions & User -->
<!-- ============================================ -->
<nav class="topbar" aria-label="Barra superior de navegación">
  <div class="topbar-container">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle d-lg-none" 
            type="button" 
            data-bs-toggle="offcanvas" 
            data-bs-target="#mobileMenu">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Search Bar -->
    <div class="search-bar">
      <i class="fas fa-search search-icon"></i>
      <input type="text" placeholder="Buscar..." class="search-input">
    </div>

    <!-- Right Section -->
    <div class="topbar-right">
      <!-- Action Icons -->
      <div class="topbar-actions">
        <!-- Notifications -->
        <button class="action-btn" title="Notificaciones">
          <i class="fas fa-bell"></i>
          <span class="notification-badge">3</span>
        </button>

        <!-- Settings -->
        <button class="action-btn d-none d-md-flex" title="Configuración">
          <i class="fas fa-cog"></i>
        </button>
      </div>

      <!-- User Dropdown -->
      <div class="user-dropdown dropdown" *ngIf="currentUser">
        <button class="user-btn"
                id="userDropdown"
                type="button"
                (click)="toggleUserDropdown()"
                [attr.aria-expanded]="isUserDropdownOpen">
          <div class="user-avatar">
            {{ currentUser?.firstName?.charAt(0) }}{{ currentUser?.lastName?.charAt(0) }}
          </div>
          <div class="user-info d-none d-lg-block">
            <div class="user-name">{{ currentUser?.firstName }} {{ currentUser?.lastName }}</div>
            <div class="user-role">{{ currentUser?.roleName?.replace('_', ' ') }}</div>
          </div>
        </button>

        <ul class="dropdown-menu dropdown-menu-end user-menu" 
            [class.show]="isUserDropdownOpen"
            aria-labelledby="userDropdown">
          <!-- User Info Header -->
          <li class="user-menu-header">
            <div class="user-avatar-large">
              {{ currentUser?.firstName?.charAt(0) }}{{ currentUser?.lastName?.charAt(0) }}
            </div>
            <div class="user-details">
              <div class="user-name-large">{{ currentUser?.firstName }} {{ currentUser?.lastName }}</div>
              <div class="user-email">{{ currentUser?.email }}</div>
              <div class="user-role-badge">{{ currentUser?.roleName?.replace('_', ' ') }}</div>
            </div>
          </li>

          <li><hr class="dropdown-divider"></li>

          <!-- Profile Link -->
          <li>
            <a class="dropdown-item" href="#" (click)="closeUserDropdown()">
              <i class="fas fa-user"></i>
              <span>Mi Perfil</span>
            </a>
          </li>

          <!-- Settings Link -->
          <li>
            <a class="dropdown-item" href="#" (click)="closeUserDropdown()">
              <i class="fas fa-cog"></i>
              <span>Configuración</span>
            </a>
          </li>

          <li><hr class="dropdown-divider"></li>

          <!-- Logout -->
          <li>
            <button class="dropdown-item logout-item" type="button" (click)="logout(); closeUserDropdown()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Cerrar Sesión</span>
            </button>
          </li>
        </ul>
      </div>

      <!-- Mobile Menu Toggle -->
      <button class="mobile-menu-toggle d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </div>
</nav>

<!-- ============================================ -->
<!-- MOBILE OFFCANVAS MENU -->
<!-- ============================================ -->
<div class="offcanvas offcanvas-start mobile-offcanvas" 
     tabindex="-1" 
     id="mobileMenu"
     style="width: 280px;">
  <div class="offcanvas-header">
    <div class="sidebar-brand">
      <div class="brand-icon">
        <i class="fas fa-building"></i>
      </div>
      <span class="brand-text">Real Estate SAS</span>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  
  <div class="offcanvas-body">
    <!-- Loading State -->
    <div class="sidebar-loading" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Cargando menú...</span>
    </div>

    <!-- Mobile Menu -->
    <ul class="sidebar-menu" *ngIf="!loading">
      <ng-container *ngFor="let menu of menuOptions; trackBy: trackByMenuId">
        <!-- Menu without children -->
        <li class="sidebar-menu-item" *ngIf="!menu.children || menu.children.length === 0">
          <a class="sidebar-menu-link"
             [routerLink]="menu.path"
             routerLinkActive="active"
             [routerLinkActiveOptions]="{exact: false}"
             data-bs-dismiss="offcanvas">
            <i [class]="getIconClass(menu.icon)"></i>
            <span class="menu-label">{{ menu.label }}</span>
          </a>
        </li>

        <!-- Menu with children -->
        <li class="sidebar-menu-item has-submenu" *ngIf="menu.children && menu.children.length > 0">
          <a class="sidebar-menu-link"
             (click)="toggleSubmenu(menu.id)"
             [class.active]="isSubmenuOpen(menu.id)">
            <i [class]="getIconClass(menu.icon)"></i>
            <span class="menu-label">{{ menu.label }}</span>
            <i class="fas fa-chevron-down submenu-icon"></i>
          </a>
          
          <!-- Submenu -->
          <ul class="sidebar-submenu" *ngIf="isSubmenuOpen(menu.id)">
            <li *ngFor="let child of menu.children; trackBy: trackByMenuId">
              <a class="sidebar-submenu-link"
                 [routerLink]="child.path"
                 routerLinkActive="active"
                 data-bs-dismiss="offcanvas">
                <i [class]="getIconClass(child.icon)"></i>
                <span>{{ child.label }}</span>
              </a>
            </li>
          </ul>
        </li>
      </ng-container>

      <!-- Empty State -->
      <li class="sidebar-empty" *ngIf="menuOptions.length === 0 && currentUser">
        <i class="fas fa-exclamation-circle"></i>
        <span>Sin opciones de menú</span>
      </li>
    </ul>
  </div>
</div>
