<div class="clients-container">
  <div class="header">
    <h1>Gestión de Clientes</h1>
    <p *ngIf="selectedRealEstateId">Gestionando clientes para Inmobiliaria ID: {{ selectedRealEstateId }}</p>
    <button class="btn btn-primary btn-add" (click)="openAddClientModal()">
      <i class="icon-plus"></i>
      Agregar Nuevo Cliente
    </button>
  </div>

  <!-- Tabla de Clientes -->
  <div class="clients-table-container">
    <table class="clients-table">
      <thead>
        <tr>
          <th>Nombre del Cliente</th>
          <th>Correo Electrónico</th>
          <th>Teléfono</th>
          <th>Propiedad</th>
          <th>Vendedor Asignado</th>
          <th>Estado del Contrato</th>
          <th>Progreso de Pagos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let client of clients">
          <td>{{ client.firstName }} {{ client.lastName }}</td>
          <td>{{ client.email }}</td>
          <td>{{ client.phone || '-' }}</td>
          <td>
            <div class="property-info">
              <div class="property-title">{{ client.property_title || 'N/A' }}</div>
              <div class="property-price" *ngIf="client.total_down_payment">
                ${{ client.total_down_payment | number:'1.0-0' }}
              </div>
            </div>
          </td>
          <td>
            <div *ngIf="client.assigned_seller; else noSeller" class="seller-info">
              <div class="seller-name">{{ client.assigned_seller.first_name }} {{ client.assigned_seller.last_name }}</div>
              <div class="seller-email">{{ client.assigned_seller.email }}</div>
            </div>
            <ng-template #noSeller>
              <span class="no-seller">Not Assigned</span>
            </ng-template>
          </td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(client)">
              {{ getClientStatus(client) }}
            </span>
          </td>
          <td>
            <div class="progress-container" *ngIf="client.total_down_payment > 0">
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="getProgressPercentage(client)">
                </div>
              </div>
              <div class="progress-text">
                {{ getProgressPercentage(client) }}% (${{ (client.total_down_payment - client.remaining_balance) | number:'1.0-0' }} / ${{ client.total_down_payment | number:'1.0-0' }})
              </div>
            </div>
            <span *ngIf="client.total_down_payment === 0" class="no-payment">No payment plan</span>
          </td>
          <td>
            <button
              class="btn btn-sm btn-assign"
              (click)="assignSeller(client)"
              [disabled]="!sellers.length">
              <i class="icon-user"></i>
              {{ client.assigned_seller_id ? 'Reassign' : 'Assign' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="clients.length === 0 && !loading">
    <i class="icon-users"></i>
    <h3>No Clients Found</h3>
    <p *ngIf="selectedRealEstateId">No clients are registered for this real estate yet.</p>
    <p *ngIf="!selectedRealEstateId">Please select a real estate to view clients.</p>
  </div>

  <!-- Assign Seller Modal -->
  <div class="modal" *ngIf="showAssignModal && selectedClient">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Seller to Client</h3>
        <button class="modal-close" (click)="closeAssignModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="client-info">
          <h4>{{ selectedClient.firstName }} {{ selectedClient.lastName }}</h4>
          <p>{{ selectedClient.email }}</p>
          <p *ngIf="selectedClient.property_title">Property: {{ selectedClient.property_title }}</p>
        </div>

        <div class="seller-selection">
          <h4>Select Seller</h4>
          <div class="seller-list">
            <div
              class="seller-item"
              *ngFor="let seller of sellers"
              [class.selected]="selectedClient.assigned_seller_id === seller.id"
              (click)="confirmAssignSeller(seller.id)">
              <div class="seller-info">
                <div class="seller-name">{{ seller.first_name }} {{ seller.last_name }}</div>
                <div class="seller-email">{{ seller.email }}</div>
              </div>
              <div class="selection-indicator" *ngIf="selectedClient.assigned_seller_id === seller.id">
                <i class="icon-check"></i>
              </div>
            </div>
          </div>

          <div class="no-sellers" *ngIf="sellers.length === 0">
            <p>No sellers available for this real estate.</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAssignModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add Client Modal -->
  <div class="modal" *ngIf="showAddClientModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>Add New Client</h3>
        <button class="modal-close" (click)="closeAddClientModal()">&times;</button>
      </div>

      <form [formGroup]="clientForm" (ngSubmit)="onSubmitClient()" class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label for="userId">Select Client *</label>
            <select
              id="userId"
              formControlName="userId"
              class="form-control"
              [class.error]="clientForm.get('userId')?.invalid && clientForm.get('userId')?.touched">
              <option value="">Select a client</option>
              <option *ngFor="let client of availableClients" [value]="client.id">
                {{ client.first_name }} {{ client.last_name }} - {{ client.email }}
              </option>
            </select>
            <div class="error-message" *ngIf="getClientFormError('userId')">
              {{ getClientFormError('userId') }}
            </div>
          </div>

          <div class="form-group">
            <label for="propertyId">Select Property *</label>
            <select
              id="propertyId"
              formControlName="propertyId"
              class="form-control"
              [class.error]="clientForm.get('propertyId')?.invalid && clientForm.get('propertyId')?.touched">
              <option value="">Select a property</option>
              <option *ngFor="let property of availableProperties" [value]="property.id">
                {{ property.title }} - ${{ property.price }}
              </option>
            </select>
            <div class="error-message" *ngIf="getClientFormError('propertyId')">
              {{ getClientFormError('propertyId') }}
            </div>
          </div>
        </div>

        <div class="form-row">

          <div class="form-group">
            <label for="assignedSellerId">Assign Seller (Optional)</label>
            <select
              id="assignedSellerId"
              formControlName="assignedSellerId"
              class="form-control">
              <option value="">No seller assigned</option>
              <option *ngFor="let seller of sellers" [value]="seller.id">
                {{ seller.first_name }} {{ seller.last_name }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contractDate">Contract Date</label>
            <input
              type="date"
              id="contractDate"
              formControlName="contractDate"
              class="form-control">
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="contractSigned">
              Contract Signed
            </label>
          </div>
        </div>
      </form>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddClientModal()" [disabled]="clientSubmitting">Cancel</button>
        <button class="btn btn-primary" (click)="onSubmitClient()" [disabled]="clientForm.invalid || clientSubmitting">
          <span *ngIf="clientSubmitting" class="spinner"></span>
          {{ clientSubmitting ? 'Creating Client...' : 'Create Client' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
  </div>
</div>
