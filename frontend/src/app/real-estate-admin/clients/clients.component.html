<div class="users-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">Gestión de Clientes</h1>
        <p class="page-subtitle">Administra todos los clientes de la inmobiliaria</p>
      </div>
      <div class="header-right">
        <button class="btn-primary" (click)="openAddClientModal()">
          <i class="fas fa-plus"></i>
          Nuevo Cliente
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon blue">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ clients.length }}</span>
        <span class="stat-label">Total Clientes</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getActiveClientsCount() }}</span>
        <span class="stat-label">Contratos Firmados</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon orange">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getPendingClientsCount() }}</span>
        <span class="stat-label">Pendientes</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">
        <i class="fas fa-user-tie"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ sellers.length }}</span>
        <span class="stat-label">Vendedores Disponibles</span>
      </div>
    </div>
  </div>

  <!-- Filters & Search -->
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Buscar clientes..." class="search-input">
      </div>
    </div>
    <div class="toolbar-right">
      <div class="filter-group">
        <label>
          <i class="fas fa-filter"></i>
          Filtrar por estado:
        </label>
        <select class="filter-select">
          <option value="">Todos los Estados</option>
          <option value="signed">Contrato Firmado</option>
          <option value="pending">Pendiente</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Clients Table Card -->
  <div class="table-card">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th style="width: 60px;">
              <div class="th-content">
                <i class="fas fa-mouse-pointer"></i>
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-user"></i>
                Cliente
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-envelope"></i>
                Correo
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-phone"></i>
                Teléfono
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-home"></i>
                Propiedad
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-user-tie"></i>
                Vendedor Asignado
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-file-contract"></i>
                Estado Contrato
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-chart-line"></i>
                Progreso de Pagos
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-cog"></i>
                Acciones
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let client of clients">
            <td style="text-align: center;">
              <button
                class="btn-select-client"
                (click)="selectClientForProperty(client)"
                title="Seleccionar cliente para asignar propiedad">
                <i class="fas fa-plus"></i>
              </button>
            </td>
            <td>
              <div class="user-cell">
                <div class="user-avatar">
                  {{ client.first_name.charAt(0) }}{{ client.last_name.charAt(0) }}
                </div>
                <div class="user-info">
                  <span class="user-name">{{ client.first_name }} {{ client.last_name }}</span>
                </div>
              </div>
            </td>
            <td>
              <span class="email-text">{{ client.email }}</span>
            </td>
            <td>
              <span class="phone-text">{{ client.phone || '-' }}</span>
            </td>
            <td>
              <div class="property-info">
                <div class="property-title" *ngIf="client.property_title; else noProperty">
                  {{ client.property_title }}
                </div>
                <ng-template #noProperty>
                  <span class="no-property">Sin propiedad asignada</span>
                </ng-template>
              </div>
            </td>
            <td>
              <div *ngIf="client.assigned_seller; else noSeller" class="seller-info">
                <div class="seller-name">{{ client.assigned_seller.first_name }} {{ client.assigned_seller.last_name }}</div>
                <div class="seller-email">{{ client.assigned_seller.email }}</div>
              </div>
              <ng-template #noSeller>
                <span class="no-seller">Sin Asignar</span>
              </ng-template>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(client)">
                {{ getClientStatus(client) }}
              </span>
            </td>
            <td>
              <div class="progress-container" *ngIf="client.total_down_payment > 0">
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    [style.width.%]="getProgressPercentage(client)">
                  </div>
                </div>
                <div class="progress-text">
                  {{ getProgressPercentage(client) }}% (${{ (client.total_down_payment - client.remaining_balance) | number:'1.0-0' }} / ${{ client.total_down_payment | number:'1.0-0' }})
                </div>
              </div>
              <span *ngIf="client.total_down_payment === 0" class="no-payment">Sin plan de pago</span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn-action btn-edit"
                  (click)="assignSeller(client)"
                  [disabled]="!sellers.length"
                  title="Asignar vendedor">
                  <i class="fas fa-user-plus"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="clients.length === 0 && !loading">
    <i class="fas fa-users"></i>
    <h3>No se encontraron clientes</h3>
    <p *ngIf="selectedRealEstateId">No hay clientes registrados para esta inmobiliaria.</p>
    <p *ngIf="!selectedRealEstateId">Por favor selecciona una inmobiliaria para ver los clientes.</p>
  </div>

  <!-- Assign Seller Modal -->
  <div class="modal-overlay" *ngIf="showAssignModal && selectedClient" (click)="closeAssignModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Asignar Vendedor a Cliente</h3>
          <button class="modal-close" (click)="closeAssignModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="client-info-section">
            <h4>{{ selectedClient.first_name }} {{ selectedClient.last_name }}</h4>
            <p>{{ selectedClient.email }}</p>
            <p *ngIf="selectedClient.property_title">Propiedad: {{ selectedClient.property_title }}</p>
          </div>

          <div class="seller-selection">
            <h4>Seleccionar Vendedor</h4>
            <div class="seller-list">
              <div
                class="seller-item"
                *ngFor="let seller of sellers"
                [class.selected]="selectedClient.assigned_seller_id === seller.id"
                (click)="confirmAssignSeller(seller.id)">
                <div class="seller-info">
                  <div class="seller-name">{{ seller.first_name }} {{ seller.last_name }}</div>
                  <div class="seller-email">{{ seller.email }}</div>
                </div>
                <div class="selection-indicator" *ngIf="selectedClient.assigned_seller_id === seller.id">
                  <i class="fas fa-check"></i>
                </div>
              </div>
            </div>

            <div class="no-sellers" *ngIf="sellers.length === 0">
              <p>No hay vendedores disponibles para esta inmobiliaria.</p>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeAssignModal()">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Client Modal -->
  <div class="modal-overlay" *ngIf="showAddClientModal" (click)="closeAddClientModal()">
    <div class="modal-dialog modal-large" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <i class="fas fa-user-plus"></i>
            Agregar Nuevo Cliente
          </h3>
          <button class="modal-close" (click)="closeAddClientModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form
          [formGroup]="clientForm"
          (ngSubmit)="onSubmitClient()"
          class="modal-body"
        >
          <div class="form-grid">
            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i>
                Correo Electrónico *
              </label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-input"
                placeholder="usuario@ejemplo.com"
                [class.error]="
                  clientForm.get('email')?.invalid &&
                  clientForm.get('email')?.touched
                "
              />
              <div class="error-message" *ngIf="getClientFormError('email')">
                {{ getClientFormError("email") }}
              </div>
            </div>

            <div class="form-group">
              <label for="password">
                <i class="fas fa-lock"></i>
                Contraseña *
              </label>
              <input
                type="password"
                id="password"
                formControlName="password"
                class="form-input"
                placeholder="Mínimo 8 caracteres"
                [class.error]="
                  clientForm.get('password')?.invalid &&
                  clientForm.get('password')?.touched
                "
              />
              <div class="error-message" *ngIf="getClientFormError('password')">
                {{ getClientFormError("password") }}
              </div>
            </div>

            <div class="form-group">
              <label for="firstName">
                <i class="fas fa-user"></i>
                Nombre *
              </label>
              <input
                type="text"
                id="firstName"
                formControlName="firstName"
                class="form-input"
                placeholder="Juan"
                [class.error]="
                  clientForm.get('firstName')?.invalid &&
                  clientForm.get('firstName')?.touched
                "
              />
              <div class="error-message" *ngIf="getClientFormError('firstName')">
                {{ getClientFormError("firstName") }}
              </div>
            </div>

            <div class="form-group">
              <label for="lastName">
                <i class="fas fa-user"></i>
                Apellido *
              </label>
              <input
                type="text"
                id="lastName"
                formControlName="lastName"
                class="form-input"
                placeholder="Pérez"
                [class.error]="
                  clientForm.get('lastName')?.invalid &&
                  clientForm.get('lastName')?.touched
                "
              />
              <div class="error-message" *ngIf="getClientFormError('lastName')">
                {{ getClientFormError("lastName") }}
              </div>
            </div>

            <div class="form-group">
              <label for="phone">
                <i class="fas fa-phone"></i>
                Teléfono
              </label>
              <input
                type="tel"
                id="phone"
                formControlName="phone"
                class="form-input"
                placeholder="+593XXXXXXXXX"
              />
            </div>

            <div class="form-group">
              <label for="propertyId">
                <i class="fas fa-home"></i>
                Seleccionar Propiedad *
              </label>
              <div class="property-selection">
                <input
                  type="text"
                  readonly
                  [value]="selectedPropertyDisplay"
                  class="form-input property-display"
                  placeholder="Haz clic para seleccionar propiedad"
                  (click)="openPropertyModal()"
                  [class.error]="
                    clientForm.get('propertyId')?.invalid &&
                    clientForm.get('propertyId')?.touched
                  "
                />
                <button
                  type="button"
                  class="btn-select-property"
                  (click)="openPropertyModal()"
                  title="Seleccionar propiedad">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>

            <!-- Property Details Preview -->
            <div class="property-preview" *ngIf="selectedProperty">
              <div class="preview-header">
                <h4>Detalles de la Propiedad Seleccionada</h4>
              </div>
              <div class="preview-content">
                <div class="preview-row">
                  <span class="preview-label">Modelo:</span>
                  <span class="preview-value">{{ selectedProperty.model_name }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Ubicación:</span>
                  <span class="preview-value">{{ selectedProperty.full_location }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Precio Total:</span>
                  <span class="preview-value">${{ selectedProperty.final_price | number:'1.0-0' }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Cuotas:</span>
                  <span class="preview-value">{{ selectedProperty.final_installments }} x ${{ selectedProperty.final_installment_amount | number:'1.0-0' }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Inicial:</span>
                  <span class="preview-value">${{ (selectedProperty.final_price * selectedProperty.final_down_payment_percentage / 100) | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <div class="error-message" *ngIf="getClientFormError('propertyId')">
              {{ getClientFormError("propertyId") }}
            </div>

            <div class="form-group">
              <label for="assignedSellerId">
                <i class="fas fa-user-tie"></i>
                Asignar Vendedor (Opcional)
              </label>
              <select
                id="assignedSellerId"
                formControlName="assignedSellerId"
                class="form-select"
              >
                <option value="">Sin vendedor asignado</option>
                <option
                  *ngFor="let seller of sellers"
                  [value]="seller.id"
                >
                  {{ seller.first_name }} {{ seller.last_name }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="contractDate">
                <i class="fas fa-calendar"></i>
                Fecha de Contrato
              </label>
              <input
                type="date"
                id="contractDate"
                formControlName="contractDate"
                class="form-input"
              />
            </div>

            <div class="form-group full-width">
              <label class="checkbox-container">
                <input type="checkbox" formControlName="contractSigned" />
                <span class="checkbox-label">
                  <i class="fas fa-file-signature"></i>
                  Contrato Firmado
                </span>
              </label>
            </div>
          </div>
        </form>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-secondary"
            (click)="closeAddClientModal()"
            [disabled]="clientSubmitting"
          >
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button
            type="button"
            class="btn-primary"
            (click)="onSubmitClient()"
            [disabled]="clientForm.invalid || clientSubmitting"
          >
            <i
              class="fas"
              [ngClass]="clientSubmitting ? 'fa-spinner fa-spin' : 'fa-check'"
            ></i>
            {{ clientSubmitting ? "Creando Cliente..." : "Crear Cliente" }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Selection Modal -->
  <div class="modal-overlay" *ngIf="showPropertyModal" (click)="closePropertyModal()">
    <div class="modal-dialog modal-xl" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <i class="fas fa-home"></i>
            Seleccionar Propiedad
          </h3>
          <button class="modal-close" (click)="closePropertyModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <!-- Property Search -->
          <div class="property-search">
            <div class="search-input-group">
              <i class="fas fa-search"></i>
              <input
                type="text"
                placeholder="Buscar propiedades..."
                class="search-input"
                [(ngModel)]="propertySearchTerm"
                (input)="filterProperties()"
              />
            </div>
          </div>

          <!-- Property Table -->
          <div class="property-table-container">
            <table class="property-table">
              <thead>
                <tr>
                  <th>Modelo</th>
                  <th>Tipo</th>
                  <th>Ubicación</th>
                  <th>Precio</th>
                  <th>Cuotas</th>
                  <th>Estado</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let property of filteredProperties"
                  [class.selected]="selectedProperty?.id === property.id"
                  (click)="selectProperty(property)">
                  <td>
                    <div class="property-model">
                      <strong>{{ property.model_name }}</strong>
                      <div class="property-details">
                        {{ property.bedrooms }} hab • {{ property.bathrooms }} baños • {{ property.area_sqm }}m²
                      </div>
                    </div>
                  </td>
                  <td>{{ property.property_type }}</td>
                  <td>
                    <div class="property-location">
                      <div>{{ property.phase_name }}</div>
                      <div class="location-detail">{{ property.block_name }} - {{ property.unit_identifier }}</div>
                    </div>
                  </td>
                  <td>
                    <div class="property-price">
                      <strong>${{ property.final_price | number:'1.0-0' }}</strong>
                      <div class="price-detail">
                        Inicial: ${{ (property.final_price * property.final_down_payment_percentage / 100) | number:'1.0-0' }}
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="installment-info">
                      {{ property.final_installments }} cuotas
                      <div class="installment-detail">
                        ${{ property.final_installment_amount | number:'1.0-0' }}/mes
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="status-badge" [ngClass]="getPropertyStatusClass(property)">
                      {{ property.status }}
                    </span>
                  </td>
                  <td>
                    <button
                      type="button"
                      class="btn-select"
                      [class.selected]="selectedProperty?.id === property.id">
                      <i class="fas" [ngClass]="selectedProperty?.id === property.id ? 'fa-check' : 'fa-plus'"></i>
                      {{ selectedProperty?.id === property.id ? 'Seleccionado' : 'Seleccionar' }}
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- No Properties Message -->
          <div class="no-properties" *ngIf="filteredProperties.length === 0">
            <i class="fas fa-home"></i>
            <h4>No se encontraron propiedades</h4>
            <p>No hay propiedades disponibles que coincidan con tu búsqueda.</p>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closePropertyModal()">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button
            type="button"
            class="btn-primary"
            (click)="confirmPropertySelection()"
            [disabled]="!selectedProperty">
            <i class="fas fa-check"></i>
            Confirmar Selección
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
  </div>
</div>
