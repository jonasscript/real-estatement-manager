<div class="users-container">
  <div class="header">
    <h1>Gestión de Usuarios</h1>
    <p *ngIf="selectedRealEstateId">Gestionando usuarios para Inmobiliaria ID: {{ selectedRealEstateId }}</p>
    <button class="btn btn-primary btn-add" (click)="openAddUserModal()">
      <i class="icon-plus"></i>
      Agregar Nuevo Cliente
    </button>
  </div>

  <!-- Tabla de Usuarios -->
  <div class="users-table-container">
    <table class="users-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Correo Electrónico</th>
          <th>Teléfono</th>
          <th>Rol</th>
          <th>Estado</th>
          <th>Fecha de Creación</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td>{{ user.firstName }} {{ user.lastName }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.phone || '-' }}</td>
          <td>{{ getRoleName(user) }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(user)">
              {{ getUserStatus(user) }}
            </span>
          </td>
          <td>{{ user.createdAt | date:'short' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Estado Vacío -->
  <div class="empty-state" *ngIf="users.length === 0 && !loading">
    <i class="icon-users"></i>
    <h3>No Se Encontraron Usuarios</h3>
    <p *ngIf="selectedRealEstateId">Aún no hay clientes registrados para esta inmobiliaria.</p>
    <p *ngIf="!selectedRealEstateId">Por favor selecciona una inmobiliaria para ver los usuarios.</p>
  </div>

  <!-- Modal Agregar Usuario -->
  <div class="modal" *ngIf="showAddUserModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>Agregar Nuevo Cliente</h3>
        <button class="modal-close" (click)="closeAddUserModal()">&times;</button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="onSubmitUser()" class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label for="email">Correo Electrónico *</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              class="form-control"
              placeholder="usuario@ejemplo.com"
              [class.error]="userForm.get('email')?.invalid && userForm.get('email')?.touched">
            <div class="error-message" *ngIf="getUserFormError('email')">
              {{ getUserFormError('email') }}
            </div>
          </div>

          <div class="form-group">
            <label for="password">Contraseña *</label>
            <input
              type="password"
              id="password"
              formControlName="password"
              class="form-control"
              placeholder="Mínimo 8 caracteres"
              [class.error]="userForm.get('password')?.invalid && userForm.get('password')?.touched">
            <div class="error-message" *ngIf="getUserFormError('password')">
              {{ getUserFormError('password') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="firstName">Nombre *</label>
            <input
              type="text"
              id="firstName"
              formControlName="firstName"
              class="form-control"
              placeholder="Juan"
              [class.error]="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
            <div class="error-message" *ngIf="getUserFormError('firstName')">
              {{ getUserFormError('firstName') }}
            </div>
          </div>

          <div class="form-group">
            <label for="lastName">Apellido *</label>
            <input
              type="text"
              id="lastName"
              formControlName="lastName"
              class="form-control"
              placeholder="Pérez"
              [class.error]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
            <div class="error-message" *ngIf="getUserFormError('lastName')">
              {{ getUserFormError('lastName') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="phone">Teléfono</label>
            <input
              type="tel"
              id="phone"
              formControlName="phone"
              class="form-control"
              placeholder="+593XXXXXXXXX">
          </div>

          <div class="form-group">
            <label for="roleId">Rol *</label>
            <select
              id="roleId"
              formControlName="roleId"
              class="form-control"
              [class.error]="userForm.get('roleId')?.invalid && userForm.get('roleId')?.touched">
              <option value="4">Cliente</option>
            </select>
            <div class="error-message" *ngIf="getUserFormError('roleId')">
              {{ getUserFormError('roleId') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="propertyId">Seleccionar Propiedad *</label>
            <select
              id="propertyId"
              formControlName="propertyId"
              class="form-control"
              [class.error]="userForm.get('propertyId')?.invalid && userForm.get('propertyId')?.touched">
              <option value="">Selecciona una propiedad</option>
              <option *ngFor="let property of availableProperties" [value]="property.id">
                {{ property.title }} - ${{ property.price }}
              </option>
            </select>
            <div class="error-message" *ngIf="getUserFormError('propertyId')">
              {{ getUserFormError('propertyId') }}
            </div>
          </div>

          <div class="form-group">
            <label for="assignedSellerId">Asignar Vendedor (Opcional)</label>
            <select
              id="assignedSellerId"
              formControlName="assignedSellerId"
              class="form-control">
              <option value="">Sin vendedor asignado</option>
              <option *ngFor="let seller of availableSellers" [value]="seller.id">
                {{ seller.first_name }} {{ seller.last_name }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contractDate">Fecha de Contrato</label>
            <input
              type="date"
              id="contractDate"
              formControlName="contractDate"
              class="form-control">
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="contractSigned">
              Contrato Firmado
            </label>
          </div>
        </div>
      </form>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddUserModal()" [disabled]="userSubmitting">Cancelar</button>
        <button class="btn btn-primary" (click)="onSubmitUser()" [disabled]="userForm.invalid || userSubmitting">
          <span *ngIf="userSubmitting" class="spinner"></span>
          {{ userSubmitting ? 'Creando Usuario...' : 'Crear Usuario' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay de Carga -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
  </div>
</div>