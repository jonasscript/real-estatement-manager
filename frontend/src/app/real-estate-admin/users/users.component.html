<div class="users-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">Gestión de Vendedores</h1>
        <p class="page-subtitle">
          Administra todos los vendedores de la inmobiliaria
        </p>
      </div>
      <div class="header-right">
        <button class="btn-primary" (click)="openAddUserModal()">
          <i class="fas fa-plus"></i>
          Nuevo Vendedor
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon blue">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ users.length }}</span>
        <span class="stat-label">Total Vendedores</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getActiveUsersCount() }}</span>
        <span class="stat-label">Vendedores Activos</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon orange">
        <i class="fas fa-user-clock"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getInactiveUsersCount() }}</span>
        <span class="stat-label">Inactivos</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">0</span>
        <span class="stat-label">Ventas del Mes</span>
      </div>
    </div>
  </div>

  <!-- Filters & Search -->
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input
          type="text"
          placeholder="Buscar vendedores..."
          class="search-input"
        />
      </div>
    </div>
    <div class="toolbar-right">
      <div class="filter-group">
        <label>
          <i class="fas fa-filter"></i>
          Filtrar por estado:
        </label>
        <select class="filter-select">
          <option value="">Todos los Estados</option>
          <option value="active">Activos</option>
          <option value="inactive">Inactivos</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Users Table Card -->
  <div class="table-card">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>
              <div class="th-content">
                <i class="fas fa-user"></i>
                Usuario
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-envelope"></i>
                Correo
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-phone"></i>
                Teléfono
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-user-tag"></i>
                Rol
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-toggle-on"></i>
                Estado
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-calendar"></i>
                Fecha de Creación
              </div>
            </th>
            <th>
              <div class="th-content">
                <i class="fas fa-cog"></i>
                Acciones
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users">
            <td>
              <div class="user-cell">
                <div class="user-avatar">
                  {{ user.first_name.charAt(0) }}{{ user.last_name.charAt(0) }}
                </div>
                <div class="user-info">
                  <span class="user-name"
                    >{{ user.first_name }} {{ user.last_name }}</span
                  >
                </div>
              </div>
            </td>
            <td>
              <span class="email-text">{{ user.email }}</span>
            </td>
            <td>
              <span class="phone-text">{{ user.phone || "-" }}</span>
            </td>
            <td>
              <span class="role-badge">{{ user.role_description }}</span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(user)">
                {{ getUserStatus(user) }}
              </span>
            </td>
            <td>
              <span class="date-text">{{
                user.created_at | date : "short"
              }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn-action btn-edit"
                  (click)="openEditModal(user)"
                  title="Editar usuario"
                >
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  class="btn-action btn-delete"
                  (click)="deleteUser(user)"
                  [disabled]="!user.is_active"
                  title="Desactivar usuario"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="users.length === 0 && !loading">
    <i class="fas fa-users"></i>
    <h3>No se encontraron vendedores</h3>
    <p *ngIf="selectedRealEstateId">
      No hay vendedores registrados para esta inmobiliaria.
    </p>
    <p *ngIf="!selectedRealEstateId">
      Por favor selecciona una inmobiliaria para ver los vendedores.
    </p>
  </div>

  <!-- Add User Modal -->
  <div
    class="modal-overlay"
    *ngIf="showAddUserModal"
    (click)="closeAddUserModal()"
  >
    <div class="modal-dialog modal-large" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <i class="fas fa-user-plus"></i>
            Agregar Nuevo Vendedor
          </h3>
          <button class="modal-close" (click)="closeAddUserModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form
          [formGroup]="userForm"
          (ngSubmit)="onSubmitUser()"
          class="modal-body"
        >
          <div class="form-grid">
            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i>
                Correo Electrónico *
              </label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-input"
                placeholder="usuario@ejemplo.com"
                [class.error]="
                  userForm.get('email')?.invalid &&
                  userForm.get('email')?.touched
                "
              />
              <div class="error-message" *ngIf="getUserFormError('email')">
                {{ getUserFormError("email") }}
              </div>
            </div>

            <div class="form-group">
              <label for="password">
                <i class="fas fa-lock"></i>
                Contraseña *
              </label>
              <input
                type="password"
                id="password"
                formControlName="password"
                class="form-input"
                placeholder="Mínimo 8 caracteres"
                [class.error]="
                  userForm.get('password')?.invalid &&
                  userForm.get('password')?.touched
                "
              />
              <div class="error-message" *ngIf="getUserFormError('password')">
                {{ getUserFormError("password") }}
              </div>
            </div>

            <div class="form-group">
              <label for="firstName">
                <i class="fas fa-user"></i>
                Nombre *
              </label>
              <input
                type="text"
                id="firstName"
                formControlName="firstName"
                class="form-input"
                placeholder="Juan"
                [class.error]="
                  userForm.get('firstName')?.invalid &&
                  userForm.get('firstName')?.touched
                "
              />
              <div class="error-message" *ngIf="getUserFormError('firstName')">
                {{ getUserFormError("firstName") }}
              </div>
            </div>

            <div class="form-group">
              <label for="lastName">
                <i class="fas fa-user"></i>
                Apellido *
              </label>
              <input
                type="text"
                id="lastName"
                formControlName="lastName"
                class="form-input"
                placeholder="Pérez"
                [class.error]="
                  userForm.get('lastName')?.invalid &&
                  userForm.get('lastName')?.touched
                "
              />
              <div class="error-message" *ngIf="getUserFormError('lastName')">
                {{ getUserFormError("lastName") }}
              </div>
            </div>

            <div class="form-group">
              <label for="phone">
                <i class="fas fa-phone"></i>
                Teléfono
              </label>
              <input
                type="tel"
                id="phone"
                formControlName="phone"
                class="form-input"
                placeholder="+593XXXXXXXXX"
              />
            </div>
          </div>
        </form>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-secondary"
            (click)="closeAddUserModal()"
            [disabled]="userSubmitting"
          >
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button
            type="button"
            class="btn-primary"
            (click)="onSubmitUser()"
            [disabled]="userForm.invalid || userSubmitting"
          >
            <i
              class="fas"
              [ngClass]="userSubmitting ? 'fa-spinner fa-spin' : 'fa-check'"
            ></i>
            {{ userSubmitting ? "Creando Vendedor..." : "Crear Vendedor" }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal with PrimeNG -->
  <p-dialog
    [(visible)]="showEditDialog"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '50vw' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
    (onHide)="cancelEdit()"
    *ngIf="editingUser"
  >
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <i class="fas fa-user-edit"></i>
        <span>Editar Usuario</span>
      </div>
    </ng-template>

    <form [formGroup]="editForm" (ngSubmit)="onUpdateUser()">
      <div class="form-grid">
        <div class="form-group">
          <label for="edit-email">
            <i class="fas fa-envelope"></i>
            Correo Electrónico
          </label>
          <input
            type="email"
            id="edit-email"
            formControlName="email"
            class="form-input"
            [disabled]="true"
            readonly
          />
        </div>

        <div class="form-group">
          <label for="edit-firstName">
            <i class="fas fa-user"></i>
            Nombre *
          </label>
          <input
            type="text"
            id="edit-firstName"
            formControlName="firstName"
            class="form-input"
            placeholder="Juan"
          />
          <div
            class="error-message"
            *ngIf="
              editForm.get('firstName')?.invalid &&
              editForm.get('firstName')?.touched
            "
          >
            El nombre es requerido (mínimo 2 caracteres)
          </div>
        </div>

        <div class="form-group">
          <label for="edit-lastName">
            <i class="fas fa-user"></i>
            Apellido *
          </label>
          <input
            type="text"
            id="edit-lastName"
            formControlName="lastName"
            class="form-input"
            placeholder="Pérez"
          />
          <div
            class="error-message"
            *ngIf="
              editForm.get('lastName')?.invalid &&
              editForm.get('lastName')?.touched
            "
          >
            El apellido es requerido (mínimo 2 caracteres)
          </div>
        </div>

        <div class="form-group">
          <label for="edit-phone">
            <i class="fas fa-phone"></i>
            Teléfono
          </label>
          <input
            type="tel"
            id="edit-phone"
            formControlName="phone"
            class="form-input"
            placeholder="+593XXXXXXXXX"
          />
        </div>

        <div class="form-group full-width">
          <label class="checkbox-container">
            <input type="checkbox" formControlName="isActive" />
            <span class="checkbox-label">
              <i class="fas fa-toggle-on"></i>
              Usuario Activo
            </span>
          </label>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button type="button" class="btn-secondary" (click)="cancelEdit()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button
          type="button"
          class="btn-primary"
          [disabled]="editForm.invalid || loading"
          (click)="onUpdateUser()"
        >
          <i
            class="fas"
            [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-check'"
          ></i>
          {{ loading ? "Actualizando..." : "Actualizar Usuario" }}
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
  </div>
</div>
